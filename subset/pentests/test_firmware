#!/bin/bash -e

REPORT=/tmp/report.txt
CONFIG=/config/device/module_config.json

TEST_NAME='security.firmware'
TEST_DESCRIPTION='Automatic bacnet firmware scan'
LOG=/tmp/firmware.log

# Error handling

if [ -f $CONFIG ]; then
    echo Extracting servers config from $CONFIG
    jq .servers $CONFIG
else
    echo No module config $CONFIG
fi

# Sanity

ping -n -c 3 $TARGET_IP

echo Testing target $TARGET_IP port 23
nc -nzv $TARGET_IP -w 5 23 || true
nc -nzv $TARGET_IP -w 5 23 || true
sleep 1
nc -nzv $TARGET_IP -w 5 23 || true
sleep 1

# Test command body

echo Running nmap 'bacnet_info' script

nmap --script bacnet-info -sU -p 47808 -oN $LOG $TARGET_IP

# Process the output of the test command

cat $LOG

touch $REPORT

# Report writing
# Format:
# --------------------
# $TEST_NAME
# --------------------
# $TEST_DESCRIPTION
# --------------------
# $LOG
# --------------------
# __RESULT__

cat <<EOF > $REPORT
--------------------
$TEST_NAME
--------------------
$TEST_DESCRIPTION
--------------------
EOF

if [ -f .fail ]; then
    echo Open ports:
    cat $REPORT
    result=fail
else
    cat $LOG >> $REPORT
    echo 'Firmware test runs with DAQ' | tee -a $REPORT
    result=pass
fi
echo '--------------------' | tee -a $REPORT
echo RESULT $result security.firmware | tee -a $REPORT

[ "$result" == pass ]
