#!/bin/bash -e

LOG=/tmp/firmware.log
REPORT=/tmp/report.txt
CONFIG=/config/device/module_config.json

if [ -f $CONFIG ]; then
    echo Extracting servers config from $CONFIG
    jq .servers $CONFIG
else
    echo No module config $CONFIG
fi

ping -n -c 3 $TARGET_IP

echo Testing target $TARGET_IP port 23
nc -nzv $TARGET_IP -w 5 23 || true
nc -nzv $TARGET_IP -w 5 23 || true
sleep 1
nc -nzv $TARGET_IP -w 5 23 || true
sleep 1

echo Running nmap 'bacnet_info' script

nmap --script bacnet-info -sU -p 47808 -oN $LOG $TARGET_IP

cat $LOG

touch $REPORT

if [ -f .fail ]; then
    echo Open ports:
    cat $REPORT
    result=fail
else
    cat $LOG >> $REPORT
    echo 'Firmware test runs with DAQ' | tee -a $REPORT
    result=pass
fi

echo RESULT $result security.firmware | tee -a $REPORT

[ "$result" == pass ]
