#!/bin/bash -e

# Set so pipe through tee will fail.
set -o pipefail

ROOT=$(realpath $(dirname $0)/..)
run_args="$@"
cmdrun_log=inst/cmdrun.log

cd $ROOT
source misc/config_base.sh

if [ -z "$run_mode" ]; then
    echo run_mode not defined.
    false
fi

echo Starting `date`, run_mode is $run_mode.
echo Clearing previous state...
sudo rm -rf inst/reports inst/run-port-* $cmdrun_log
mkdir -p inst
sudo chown -f $USER -R inst || true

if [ -n "$build_tests" ]; then
    cmd/build
fi

bin/build_hash check

if [ "$run_mode" == local ]; then
    cmd/exrun $run_args 2>&1 | tee $cmdrun_log
else
    cmd/inrun $run_args 2>&1 | tee $cmdrun_log
fi
